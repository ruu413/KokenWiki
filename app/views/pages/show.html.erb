<%= render "pages/layout" do %>
    <%= render partial: "pages/pankuzu" %>
    <h1><%= @page.title %></h1>
    <p>
        <%= render "update-timestamp", history: @page %>
    </p>
    <% if @page.children.size == 0 && @editable %>
        <%= form_with scope: :page, method: :delete do |form| %>
            <% form.submit "削除", {class: "btn btn-danger", style: "float: right;", data: {confirm: "本当に削除しますか"}} %>
        <% end %>
    <% end %>
    <%= form_with scope: :page, method: :put do %>
        <%= react_component("MdEditor",
            markdown: @page.content,
            is_draft: @page.is_draft,
            is_public: @page.is_public,
            readable_group_id: @page.readable_group_id || 0,
            editable_group_id: @page.editable_group_id || 0,
            editable: @editable,
            usergroups: current_user != nil ? current_user.usergroups.select(:id, :name) : []
        ) %>
    <% end %>
    <h2 class="h3">ファイル</h2>
    <ul class="list-group">
        <% @page.files.each do |file| %>
            <li class="list-group-item d-flex justify-content-between">
                <%= link_to file.blob.filename.to_s, (@pathname + file.blob.filename.to_s).to_s %>
                <% if @editable %>
                    <%= form_with url:URI.encode((@pathname + file.blob.filename.to_s).to_s), method: :delete, html: {style: "display:inline"}, remote: true do |form| %>
                        <% form.submit "削除", {class: "btn btn-danger btn-sm", data: {confirm: "本当に"+file.blob.filename.to_s+"を削除しますか"}} %>
                    <% end %>
                <% end %>
            </li>
        <% end %>
    </ul>
    <% if user_signed_in? %>
        <%= form_with scope: :file, method: :post do |form| %>
            <%= form.file_field :files, :multiple => true %>
            <%= form.submit "送信", class: "btn btn-primary" %>
        <% end %>
    <% end %>
    <h2 class="h3">更新履歴</h2>
    <ol style="list-style-type: none; padding-left: 0">
        <% @update_histories.limit(10).each_cons(2) do |newHist, oldHist| %>
            <li>
                <details>
                    <summary>
                        <%= render "update-timestamp", history: newHist %>
                    </summary>
                    <%= react_component("DiffViewer",
                        oldValue: oldHist.content,
                        newValue: newHist.content
                    )%>
                </details>
            </li>
        <% end %>
        <% if @update_histories.present? %>
            <li>
                <%= render "update-timestamp", history: @update_histories.last %>
            </li>
        <% end %>
    </ol>
<% end %>
<script src="https://cdn.jsdelivr.net/npm/@github/time-elements@3.0.10/dist/time-elements-legacy.min.js" module async></script>
